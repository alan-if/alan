#!/usr/bin/env bash
#
# Script for regression testing of Alan and Arun
# Files:
#   .regr - the command to be run using the case name as the single arg
#           also indicates that this directory should be recursed into
#   .case - the extension (including period) to be considered test cases
#           if available indicates that there are cases in this directory
#

run ()
{
    echo -n "$theCase : "
    if [ ! -f $theCase.suspended ]
    then
	echo "########## $theCase ##########" >$theCase.output
	./.regr $theCase >>$theCase.output 2>&1
	theCases=`expr $theCases + 1`
    fi
}

verify()
{
    if [ -f $theCase.suspended ]
    then
	suspended=`expr $suspended + 1`
	echo "Suspended..."
    else if [ -f $theCase.expected ]
    then
	if diff -q -b $theCase.output $theCase.expected 1> /dev/null
	then
	    ok=`expr $ok + 1`
	    echo -n "
[K"
	    rm $theCase.output
	else
	    failed=`expr $failed + 1`
	    echo "*** FAILED!!! ***"
	fi
    else
	new=`expr $new + 1`
	echo "NEW!"
    fi
    fi
}

recurse()
{
  for d in *; do
    if [ -d $d ]
    then
	if [ -f $d/.regr ]
	then
	    echo "Recursing: $d"
	    cd $d; regr; cd ..
	    echo "Leaving: $d"
	fi
    fi
  done
}

runselected()
{
  for f in ${*} ; do
    theCase=`basename $f $ext`
    if [ "$theCase" != "$f" ]
    then
      run
      verify
    elif [ -f $theCase$ext ]
      then
	run
	verify
    fi
  done
}

theCases=0
ok=0
failed=0
suspended=0
new=0

if [ $# = 0 ] ; then
  recurse
fi

if [ -f .case ] ; then
  ext=`cat .case`
  if [ $# != 0 ] ; then
    runselected ${*}
  else
    if [ -f .regr ]
    then
      for f in *$ext ; do
	theCase=`basename $f $ext`
	run
	verify
      done
    fi
  fi
  if test $new -ne 0
  then
    echo -n "$new new, "
  fi
  if test $suspended -ne 0
  then
    echo -n "$suspended suspended, "
  fi
  if test $failed -eq 0
  then
    if test $new -eq 0
    then
      echo All $theCases OK!
    else
      echo $ok OK!
    fi
  else
    echo "*** $failed FAILED! ***"
  fi
else
  echo No cases to run in `pwd`
fi


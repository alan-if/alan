#include <cgreen/cgreen.h>

#include "converter.h"

#include <errno.h>

#include "lst_x.h"

#include "lmList.mock"
#include "lmlog.mock"
#include "srcp.mock"


static iconv_t cd;

Describe(Converter);
BeforeEach(Converter) {
    cd = initUtf8Conversion();
}
AfterEach(Converter) {
    finishUtf8Conversion(cd);
}


Ensure(Converter, should_return_zero_for_empty_string) {
    uchar input[100] = "";
    uchar output[100] = "";
    uchar *input_p = &input[0];
    uchar *output_p = &output[0];

    assert_that(convertUtf8ToInternal(cd, &input_p, &output_p, 0), is_equal_to(0));
}

Ensure(Converter, should_pass_newline_through) {
    uchar input[100] = "\n";
    uchar output[100];
    uchar *input_p = &input[0];
    uchar *output_p = &output[0];

    assert_that(convertUtf8ToInternal(cd, &input_p, &output_p, 1), is_equal_to(1));
    output[1] = '\0';
    assert_that(output, is_equal_to_string("\n"));
}

Ensure(Converter, should_convert_lower_aring) {
    uchar input[100] = {0xC3, 0xA5};
    uchar output[100] = "";
    uchar *input_p = &input[0];
    uchar *output_p = &output[0];

    assert_that(convertUtf8ToInternal(cd, &input_p, &output_p, 2), is_equal_to(1));
    assert_that(output[0], is_equal_to_hex(0xE5));
}

Ensure(Converter, should_convert_long_utf_text) {
    uchar input[] = "AstraZenecas vaccin har en hög skyddseffekt och minskar kraftigt risken för svår sjukdom och död, särskilt bland äldre och svaga. De inrapporterade fallen av allvarliga biverkningar är sällsynta och rör i de flesta fallen personer under 60 år, säger statsepidemiolog Anders Tegnell.\nPersoner under 65 år som redan har fått en dos av Vaxzevria ska istället erbjudas en andra dos av så kallade mRNA-vaccin, som PfizerBiontech eller Moderna. Däremot finns det inga studier ännu på hur skyddseffekten blir.";
    uchar output[1000] = "";
    uchar expected[] = {0x41, 0x73, 0x74, 0x72, 0x61, 0x5A, 0x65, 0x6E, 0x65, 0x63, 0x61, 0x73, 0x20,
                        0x76, 0x61, 0x63, 0x63, 0x69, 0x6E, 0x20,
                        0x68, 0x61, 0x72, 0x20,
                        0x65, 0x6E, 0x20,
                        0x68, 0xf6, 0x67, 0x20,
                        0x73, 0x6B, 0x79, 0x64, 0x64, 0x73, 0x65, 0x66, 0x66, 0x65, 0x6B, 0x74, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x6D, 0x69, 0x6E, 0x73, 0x6B, 0x61, 0x72, 0x20,
                        0x6B, 0x72, 0x61, 0x66, 0x74, 0x69, 0x67, 0x74, 0x20,
                        0x72, 0x69, 0x73, 0x6B, 0x65, 0x6E, 0x20,
                        0x66, 0xf6, 0x72, 0x20,
                        0x73, 0x76, 0xe5, 0x72, 0x20,
                        0x73, 0x6A, 0x75, 0x6B, 0x64, 0x6F, 0x6D, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x64, 0xf6, 0x64, 0x2C, 0x20,
                        0x73, 0xe4, 0x72, 0x73, 0x6B, 0x69, 0x6C, 0x74, 0x20,
                        0x62, 0x6C, 0x61, 0x6E, 0x64, 0x20,
                        0xe4, 0x6C, 0x64, 0x72, 0x65, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x73, 0x76, 0x61, 0x67, 0x61, 0x2E, 0x20,
                        0x44, 0x65, 0x20,
                        0x69, 0x6E, 0x72, 0x61, 0x70, 0x70, 0x6F, 0x72, 0x74, 0x65, 0x72, 0x61, 0x64, 0x65, 0x20,
                        0x66, 0x61, 0x6C, 0x6C, 0x65, 0x6E, 0x20,
                        0x61, 0x76, 0x20,
                        0x61, 0x6C, 0x6C, 0x76, 0x61, 0x72, 0x6C, 0x69, 0x67, 0x61, 0x20,
                        0x62, 0x69, 0x76, 0x65, 0x72, 0x6B, 0x6E, 0x69, 0x6E, 0x67, 0x61, 0x72, 0x20,
                        0xe4, 0x72, 0x20,
                        0x73, 0xe4, 0x6C, 0x6C, 0x73, 0x79, 0x6E, 0x74, 0x61, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x72, 0xf6, 0x72, 0x20,
                        0x69, 0x20,
                        0x64, 0x65, 0x20,
                        0x66, 0x6C, 0x65, 0x73, 0x74, 0x61, 0x20,
                        0x66, 0x61, 0x6C, 0x6C, 0x65, 0x6E, 0x20,
                        0x70, 0x65, 0x72, 0x73, 0x6F, 0x6E, 0x65, 0x72, 0x20,
                        0x75, 0x6E, 0x64, 0x65, 0x72, 0x20,
                        0x36, 0x30, 0x20,
                        0xe5, 0x72, 0x2C, 0x20,
                        0x73, 0xe4, 0x67, 0x65, 0x72, 0x20,
                        0x73, 0x74, 0x61, 0x74, 0x73, 0x65, 0x70, 0x69, 0x64, 0x65, 0x6D, 0x69, 0x6F, 0x6C, 0x6F, 0x67, 0x20,
                        0x41, 0x6E, 0x64, 0x65, 0x72, 0x73, 0x20,
                        0x54, 0x65, 0x67, 0x6E, 0x65, 0x6C, 0x6C, 0x2E, 0x0A,
                        0x50, 0x65, 0x72, 0x73, 0x6F, 0x6E, 0x65, 0x72, 0x20,
                        0x75, 0x6E, 0x64, 0x65, 0x72, 0x20,
                        0x36, 0x35, 0x20,
                        0xe5, 0x72, 0x20,
                        0x73, 0x6F, 0x6D, 0x20,
                        0x72, 0x65, 0x64, 0x61, 0x6E, 0x20,
                        0x68, 0x61, 0x72, 0x20,
                        0x66, 0xe5, 0x74, 0x74, 0x20,
                        0x65, 0x6E, 0x20,
                        0x64, 0x6F, 0x73, 0x20,
                        0x61, 0x76, 0x20,
                        0x56, 0x61, 0x78, 0x7A, 0x65, 0x76, 0x72, 0x69, 0x61, 0x20,
                        0x73, 0x6B, 0x61, 0x20,
                        0x69, 0x73, 0x74, 0xe4, 0x6C, 0x6C, 0x65, 0x74, 0x20,
                        0x65, 0x72, 0x62, 0x6A, 0x75, 0x64, 0x61, 0x73, 0x20,
                        0x65, 0x6E, 0x20,
                        0x61, 0x6E, 0x64, 0x72, 0x61, 0x20,
                        0x64, 0x6F, 0x73, 0x20,
                        0x61, 0x76, 0x20,
                        0x73, 0xe5, 0x20,
                        0x6B, 0x61, 0x6C, 0x6C, 0x61, 0x64, 0x65, 0x20,
                        0x6D, 0x52, 0x4E, 0x41, 0x2D, 0x76, 0x61, 0x63, 0x63, 0x69, 0x6E, 0x2C, 0x20,
                        0x73, 0x6F, 0x6D, 0x20,
                        0x50, 0x66, 0x69, 0x7A, 0x65, 0x72, 0x42, 0x69, 0x6F, 0x6E, 0x74, 0x65, 0x63, 0x68, 0x20,
                        0x65, 0x6C, 0x6C, 0x65, 0x72, 0x20,
                        0x4D, 0x6F, 0x64, 0x65, 0x72, 0x6E, 0x61, 0x2E, 0x20,
                        0x44, 0xe4, 0x72, 0x65, 0x6D, 0x6F, 0x74, 0x20,
                        0x66, 0x69, 0x6E, 0x6E, 0x73, 0x20,
                        0x64, 0x65, 0x74, 0x20,
                        0x69, 0x6E, 0x67, 0x61, 0x20,
                        0x73, 0x74, 0x75, 0x64, 0x69, 0x65, 0x72, 0x20,
                        0xe4, 0x6E, 0x6E, 0x75, 0x20,
                        0x70, 0xe5, 0x20,
                        0x68, 0x75, 0x72, 0x20,
                        0x73, 0x6B, 0x79, 0x64, 0x64, 0x73, 0x65, 0x66, 0x66, 0x65, 0x6B, 0x74, 0x65, 0x6E, 0x20,
                        0x62, 0x6C, 0x69, 0x72, 0x2E};
    uchar *input_p = &input[0];
    uchar *output_p = &output[0];

    assert_that(convertUtf8ToInternal(cd, &input_p, &output_p, strlen((char *)input)), is_equal_to(502));
    for (int i=0; i<strlen((char*)output); i++)
        if (output[i] != expected[i])
            printf("mismatch in position %d\n", i);
    output[502] = '\0';
    assert_that(output, is_equal_to_string((char*)expected));
}


Ensure(Converter, should_convert_long_utf_text_in_chunks) {
    uchar input[] = "AstraZenecas vaccin har en hög skyddseffekt och minskar kraftigt risken för svår sjukdom och död, särskilt bland äldre och svaga. De inrapporterade fallen av allvarliga biverkningar är sällsynta och rör i de flesta fallen personer under 60 år, säger statsepidemiolog Anders Tegnell.\nPersoner under 65 år som redan har fått en dos av Vaxzevria ska istället erbjudas en andra dos av så kallade mRNA-vaccin, som PfizerBiontech eller Moderna. Däremot finns det inga studier ännu på hur skyddseffekten blir.";
    uchar output[1000] = "";
    uchar expected[] = {0x41, 0x73, 0x74, 0x72, 0x61, 0x5A, 0x65, 0x6E, 0x65, 0x63, 0x61, 0x73, 0x20,
                        0x76, 0x61, 0x63, 0x63, 0x69, 0x6E, 0x20,
                        0x68, 0x61, 0x72, 0x20,
                        0x65, 0x6E, 0x20,
                        0x68, 0xf6, 0x67, 0x20,
                        0x73, 0x6B, 0x79, 0x64, 0x64, 0x73, 0x65, 0x66, 0x66, 0x65, 0x6B, 0x74, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x6D, 0x69, 0x6E, 0x73, 0x6B, 0x61, 0x72, 0x20,
                        0x6B, 0x72, 0x61, 0x66, 0x74, 0x69, 0x67, 0x74, 0x20,
                        0x72, 0x69, 0x73, 0x6B, 0x65, 0x6E, 0x20,
                        0x66, 0xf6, 0x72, 0x20,
                        0x73, 0x76, 0xe5, 0x72, 0x20,
                        0x73, 0x6A, 0x75, 0x6B, 0x64, 0x6F, 0x6D, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x64, 0xf6, 0x64, 0x2C, 0x20,
                        0x73, 0xe4, 0x72, 0x73, 0x6B, 0x69, 0x6C, 0x74, 0x20,
                        0x62, 0x6C, 0x61, 0x6E, 0x64, 0x20,
                        0xe4, 0x6C, 0x64, 0x72, 0x65, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x73, 0x76, 0x61, 0x67, 0x61, 0x2E, 0x20,
                        0x44, 0x65, 0x20,
                        0x69, 0x6E, 0x72, 0x61, 0x70, 0x70, 0x6F, 0x72, 0x74, 0x65, 0x72, 0x61, 0x64, 0x65, 0x20,
                        0x66, 0x61, 0x6C, 0x6C, 0x65, 0x6E, 0x20,
                        0x61, 0x76, 0x20,
                        0x61, 0x6C, 0x6C, 0x76, 0x61, 0x72, 0x6C, 0x69, 0x67, 0x61, 0x20,
                        0x62, 0x69, 0x76, 0x65, 0x72, 0x6B, 0x6E, 0x69, 0x6E, 0x67, 0x61, 0x72, 0x20,
                        0xe4, 0x72, 0x20,
                        0x73, 0xe4, 0x6C, 0x6C, 0x73, 0x79, 0x6E, 0x74, 0x61, 0x20,
                        0x6F, 0x63, 0x68, 0x20,
                        0x72, 0xf6, 0x72, 0x20,
                        0x69, 0x20,
                        0x64, 0x65, 0x20,
                        0x66, 0x6C, 0x65, 0x73, 0x74, 0x61, 0x20,
                        0x66, 0x61, 0x6C, 0x6C, 0x65, 0x6E, 0x20,
                        0x70, 0x65, 0x72, 0x73, 0x6F, 0x6E, 0x65, 0x72, 0x20,
                        0x75, 0x6E, 0x64, 0x65, 0x72, 0x20,
                        0x36, 0x30, 0x20,
                        0xe5, 0x72, 0x2C, 0x20,
                        0x73, 0xe4, 0x67, 0x65, 0x72, 0x20,
                        0x73, 0x74, 0x61, 0x74, 0x73, 0x65, 0x70, 0x69, 0x64, 0x65, 0x6D, 0x69, 0x6F, 0x6C, 0x6F, 0x67, 0x20,
                        0x41, 0x6E, 0x64, 0x65, 0x72, 0x73, 0x20,
                        0x54, 0x65, 0x67, 0x6E, 0x65, 0x6C, 0x6C, 0x2E, 0x0A,
                        0x50, 0x65, 0x72, 0x73, 0x6F, 0x6E, 0x65, 0x72, 0x20,
                        0x75, 0x6E, 0x64, 0x65, 0x72, 0x20,
                        0x36, 0x35, 0x20,
                        0xe5, 0x72, 0x20,
                        0x73, 0x6F, 0x6D, 0x20,
                        0x72, 0x65, 0x64, 0x61, 0x6E, 0x20,
                        0x68, 0x61, 0x72, 0x20,
                        0x66, 0xe5, 0x74, 0x74, 0x20,
                        0x65, 0x6E, 0x20,
                        0x64, 0x6F, 0x73, 0x20,
                        0x61, 0x76, 0x20,
                        0x56, 0x61, 0x78, 0x7A, 0x65, 0x76, 0x72, 0x69, 0x61, 0x20,
                        0x73, 0x6B, 0x61, 0x20,
                        0x69, 0x73, 0x74, 0xe4, 0x6C, 0x6C, 0x65, 0x74, 0x20,
                        0x65, 0x72, 0x62, 0x6A, 0x75, 0x64, 0x61, 0x73, 0x20,
                        0x65, 0x6E, 0x20,
                        0x61, 0x6E, 0x64, 0x72, 0x61, 0x20,
                        0x64, 0x6F, 0x73, 0x20,
                        0x61, 0x76, 0x20,
                        0x73, 0xe5, 0x20,
                        0x6B, 0x61, 0x6C, 0x6C, 0x61, 0x64, 0x65, 0x20,
                        0x6D, 0x52, 0x4E, 0x41, 0x2D, 0x76, 0x61, 0x63, 0x63, 0x69, 0x6E, 0x2C, 0x20,
                        0x73, 0x6F, 0x6D, 0x20,
                        0x50, 0x66, 0x69, 0x7A, 0x65, 0x72, 0x42, 0x69, 0x6F, 0x6E, 0x74, 0x65, 0x63, 0x68, 0x20,
                        0x65, 0x6C, 0x6C, 0x65, 0x72, 0x20,
                        0x4D, 0x6F, 0x64, 0x65, 0x72, 0x6E, 0x61, 0x2E, 0x20,
                        0x44, 0xe4, 0x72, 0x65, 0x6D, 0x6F, 0x74, 0x20,
                        0x66, 0x69, 0x6E, 0x6E, 0x73, 0x20,
                        0x64, 0x65, 0x74, 0x20,
                        0x69, 0x6E, 0x67, 0x61, 0x20,
                        0x73, 0x74, 0x75, 0x64, 0x69, 0x65, 0x72, 0x20,
                        0xe4, 0x6E, 0x6E, 0x75, 0x20,
                        0x70, 0xe5, 0x20,
                        0x68, 0x75, 0x72, 0x20,
                        0x73, 0x6B, 0x79, 0x64, 0x64, 0x73, 0x65, 0x66, 0x66, 0x65, 0x6B, 0x74, 0x65, 0x6E, 0x20,
                        0x62, 0x6C, 0x69, 0x72, 0x2E};

#define CHUNK_SIZE 9

    int total = 0;

    int input_processed = 0;
    int input_left = strlen((char *)input);
    while (input_left > 0) {
        uchar input_buf[CHUNK_SIZE];
        uchar output_buf[CHUNK_SIZE];
        uchar *input_p = &input_buf[0];
        uchar *output_p = &output_buf[0];

        int left = input_left < CHUNK_SIZE? input_left : CHUNK_SIZE;

        /* Fill input buffer */
        memcpy(input_buf, &input[input_processed], left);

        int converted = convertUtf8ToInternal(cd, &input_p, &output_p, left); /* Convert a chunk */
        if (converted == -1) {
            if (errno == EINVAL) {
                /* Cut off in the middle of multi-byte, input_p points after successfully decoded */
                converted = output_p - output_buf;
            } else {
                break;
            }
        }

        /* input_p points after last input used, so there might be leftovers... */
        input_processed += input_p - input_buf;
        input_left -= input_p - input_buf;

        memcpy(&output[total], output_buf, converted);
        total += converted;
    }

    for (int i=0; i<strlen((char*)output); i++)
        if (output[i] != expected[i])
            printf("mismatch in position %d\n", i);
    output[502] = '\0';
    assert_that(output, is_equal_to_string((char*)expected));
}

Ensure(Converter, can_read_and_convert_multiple_buffered) {
    uchar first[] = "abc";    /* First read */
    uchar second[] = "xyz";   /* Second half */
    uchar buffer[100];

    expect(mocked_read, when(fd, is_equal_to(12)),
           will_set_contents_of_parameter(buf, first, 3),
           will_return(3));

    expect(mocked_read, when(fd, is_equal_to(12)),
           will_set_contents_of_parameter(buf, second, 3),
           will_return(3));

    /* Read first part with half a sequence, should only convert what is complete (abc) */
    int count = readWithConversionFromUtf8(12, cd, buffer, 3);
    assert_that(count, is_equal_to(3));
    assert_that(memcmp(buffer, first, 3), is_equal_to(0));

    count = readWithConversionFromUtf8(12, cd, buffer, 3);
    assert_that(count, is_equal_to(3));
    assert_that(memcmp(buffer, second, 3), is_equal_to(0));
}


Ensure(Converter, can_handle_sequences_broken_across_reads) {
    uchar first[] = "abc\xc3";    /* First read with half the sequence \xc3\x84 - 'Ä' (\xc4 in ISO) */
    uchar second[] = "\x84xyz";   /* Second half */
    uchar buffer[100];

    expect(mocked_read, when(fd, is_equal_to(12)),
           will_set_contents_of_parameter(buf, first, 4),
           will_return(4));

    expect(getErrno, will_return(EINVAL));

    expect(mocked_read, when(fd, is_equal_to(12)),
           will_set_contents_of_parameter(buf, second, 4),
           will_return(4));

    /* Read first part with half a sequence, should only convert what is complete (abc) */
    int count = readWithConversionFromUtf8(12, cd, buffer, 4);
    assert_that(count, is_equal_to(3));

    count = readWithConversionFromUtf8(12, cd, buffer, 4);
    assert_that(count, is_equal_to(4));
}
